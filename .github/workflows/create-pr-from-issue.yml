name: Create Pull Request from Issue
on:
  issues:
    types: [labeled]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'neues-treffen')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      - name: Extract Issue Data
        id: extract-issue
        run: |
          BODY="${{ github.event.issue.body }}"
          
          # Extrahiere Felder aus dem Format: "### Feldname\n\nWert\n"
          # Das Template hat eine Leerzeile zwischen Heading und Wert
          HASHTAG=$(echo "$BODY" | awk '/### Hashtag/{getline; getline; print}' | xargs)
          ORT=$(echo "$BODY" | awk '/### Ort/{getline; getline; print}' | xargs)
          LAT=$(echo "$BODY" | awk '/### Breitengrad/{getline; getline; print}' | xargs)
          LNG=$(echo "$BODY" | awk '/### Längengrad/{getline; getline; print}' | xargs)
          BESCHREIBUNG=$(echo "$BODY" | awk '/### Beschreibung/{getline; getline; print}' | xargs)
          
          # Validierung erforderlicher Felder
          if [ -z "$HASHTAG" ] || [ -z "$ORT" ] || [ -z "$LAT" ] || [ -z "$LNG" ]; then
            echo "❌ Fehler: Erforderliche Felder fehlen"
            echo "Hashtag: '$HASHTAG'"
            echo "Ort: '$ORT'"
            echo "Lat: '$LAT'"
            echo "Lng: '$LNG'"
            exit 1
          fi
          
          # Validiere Zahlenformat für Koordinaten
          if ! echo "$LAT" | grep -qE '^-?[0-9]+(\.[0-9]+)?$'; then
            echo "❌ Fehler: Breitengrad ist keine gültige Zahl: $LAT"
            exit 1
          fi
          if ! echo "$LNG" | grep -qE '^-?[0-9]+(\.[0-9]+)?$'; then
            echo "❌ Fehler: Längengrad ist keine gültige Zahl: $LNG"
            exit 1
          fi
          
          # Erstelle JSON-Objekt
          NEW_MEETUP=$(jq -n \
            --arg hashtag "$HASHTAG" \
            --arg ort "$ORT" \
            --arg lat "$LAT" \
            --arg lng "$LNG" \
            --arg beschreibung "$BESCHREIBUNG" \
            '{hashtag: $hashtag, ort: $ort, lat: ($lat | tonumber), lng: ($lng | tonumber), mastodon_server: "mastodon.social", beschreibung: $beschreibung}')
          
          echo "NEW_MEETUP=$NEW_MEETUP" >> $GITHUB_ENV
          echo "✅ Erfolgreich extrahiert:"
          echo "$NEW_MEETUP" | jq .

      - name: Create New Branch
        run: |
          git checkout -b "neues-treffen-${{ github.event.issue.number }}"

      - name: Update meetups.json
        run: |
          # Stelle sicher, dass meetups.json existiert
          if [ ! -f "meetups.json" ]; then
            echo "[]" > meetups.json
          fi
          
          # Füge das neue Treffen zur meetups.json hinzu
          jq --argjson new_meetup "$NEW_MEETUP" '. += [$new_meetup]' meetups.json > meetups_temp.json && mv meetups_temp.json meetups.json

      - name: Commit and Push Changes
        run: |
          git add meetups.json
          git commit -m "Neues Treffen hinzugefügt: ${{ github.event.issue.title }}"
          git push origin "neues-treffen-${{ github.event.issue.number }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Neues Treffen hinzugefügt: ${{ github.event.issue.title }}"
          title: "Neues Treffen: ${{ github.event.issue.title }}"
          body: |
            Dieses Pull Request fügt ein neues Treffen hinzu, das über ein Issue vorgeschlagen wurde:
            ${{ github.event.issue.html_url }}

            Bitte prüfe folgende Punkte:
            - Koordinaten korrekt?
            - Hashtag richtig geschrieben?
            - Beschreibung sinnvoll?
          branch: "neues-treffen-${{ github.event.issue.number }}"
          base: main
          delete-branch: true
