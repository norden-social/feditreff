name: Create Pull Request from Issue
on:
  issues:
    types: [labeled, opened]

jobs:
  create-pr:
    if: contains(github.event.issue.labels.*.name, 'neues-treffen') || contains(github.event.issue.labels.*.name, 'neues treffen')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      - name: Extract Issue Data
        id: extract-issue
        run: |
          BODY="${{ github.event.issue.body }}"
          
          # Extrahiere Felder aus dem Format: "### Feldname\n\nWert\n"
          HASHTAG=$(echo "$BODY" | awk '/### Hashtag/{getline; getline; print}' | xargs)
          ORT=$(echo "$BODY" | awk '/### Ort/{getline; getline; print}' | xargs)
          LAT=$(echo "$BODY" | awk '/### Breitengrad/{getline; getline; print}' | xargs)
          LNG=$(echo "$BODY" | awk '/### LÃ¤ngengrad/{getline; getline; print}' | xargs)
          BESCHREIBUNG=$(echo "$BODY" | awk '/### Beschreibung/{getline; getline; print}' | xargs)
          
          # Validierung erforderlicher Felder
          if [ -z "$HASHTAG" ] || [ -z "$ORT" ]; then
            echo "Fehler: Hashtag und Ort sind erforderlich"
            exit 1
          fi
          
          # Wenn Koordinaten nicht angegeben, finde sie automatisch aus der Adresse
          if [ -z "$LAT" ] || [ -z "$LNG" ]; then
            echo "Geocodiere Adresse: $ORT"
            # URL-encode die Adresse fÃ¼r Nominatim
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$ORT'))")
            GEOCODING=$(curl -s "https://nominatim.openstreetmap.org/search?q=$ENCODED&format=json&limit=1")
            LAT=$(echo "$GEOCODING" | jq -r '.[0].lat // empty')
            LNG=$(echo "$GEOCODING" | jq -r '.[0].lon // empty')
            
            if [ -z "$LAT" ] || [ -z "$LNG" ]; then
              echo "Fehler: Konnte Koordinaten fÃ¼r '$ORT' nicht finden"
              exit 1
            fi
            echo "Gefundene Koordinaten - Lat: $LAT, Lng: $LNG"
          fi
          
          # Validiere Zahlenformat fÃ¼r Koordinaten
          if ! echo "$LAT" | grep -qE '^-?[0-9]+(\.[0-9]+)?$'; then
            echo "Fehler: Breitengrad ist keine gÃ¼ltige Zahl: $LAT"
            exit 1
          fi
          if ! echo "$LNG" | grep -qE '^-?[0-9]+(\.[0-9]+)?$'; then
            echo "Fehler: LÃ¤ngengrad ist keine gÃ¼ltige Zahl: $LNG"
            exit 1
          fi
          
          # Erstelle JSON-Objekt mit sicheren String-Parametern
          NEW_MEETUP=$(jq -n \
            --arg hashtag "$HASHTAG" \
            --arg ort "$ORT" \
            --arg lat "$LAT" \
            --arg lng "$LNG" \
            --arg beschreibung "$BESCHREIBUNG" \
            '{hashtag: $hashtag, ort: $ort, lat: ($lat | tonumber), lng: ($lng | tonumber), mastodon_server: "mastodon.social", beschreibung: $beschreibung}')
          
          # Speichere als Output fÃ¼r nÃ¤chste Steps
          echo "meetup=$(echo "$NEW_MEETUP" | jq -c .)" >> $GITHUB_OUTPUT

      - name: Update meetups.json
        run: |
          # Stelle sicher, dass meetups.json existiert
          if [ ! -f "meetups.json" ]; then
            echo "[]" > meetups.json
          fi
          
          # FÃ¼ge das neue Treffen zur meetups.json hinzu
          jq --argjson new_meetup '${{ steps.extract-issue.outputs.meetup }}' '. += [$new_meetup]' meetups.json > meetups_temp.json && mv meetups_temp.json meetups.json

      - name: Create Branch and Push
        run: |
          BRANCH="neues-treffen-${{ github.event.issue.number }}"
          # LÃ¶sche Remote-Branch falls er existiert
          git push origin --delete "$BRANCH" || true
          # Erstelle neuen Branch
          git checkout -b "$BRANCH"
          git add meetups.json
          git commit -m "Neues Treffen hinzugefÃ¼gt: ${{ github.event.issue.title }}"
          git push -u origin "$BRANCH"

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Neues Treffen hinzugefÃ¼gt!\n\nDie Daten wurden in die `meetups.json` eingefÃ¼gt und sind im Branch `neues-treffen-${{ github.event.issue.number }}` verfÃ¼gbar.\n\nðŸ‘‰ [Pull Request erstellen](https://github.com/${{ github.repository }}/compare/main...neues-treffen-${{ github.event.issue.number }}?quick_pull=1)'
            })
